<div class="admin-products-container">
  <div class="products-header">
    <h1>Product Management</h1>
    <button (click)="openAddProductModal()" class="btn-add-new">
      + Add New Product
    </button>
  </div>

  <div class="search-bar">
    <input
      type="text"
      placeholder="Search by product name or ID..."
      [(ngModel)]="searchTerm"
      (keyup.enter)="onSearch()"
      class="search-input"
    />
    <button (click)="onSearch()" class="btn-search">Search</button>
    <button (click)="clearSearch()" class="btn-clear">Clear</button>
  </div>

  <!-- Filters Section -->
  <div class="filters-section">
    <h3>Filters</h3>
    <div class="filters-grid">
      <!-- Category Filter -->
      <!-- <div class="filter-group">
        <label>Category</label>
        <select [(ngModel)]="selectedCategoryId" class="filter-input">
          <option [value]="null">All Categories</option>
          <option *ngFor="let category of categories" [value]="category.id">
            {{ category.name }} 
          </option>
        </select>
      </div> -->

      <!-- Price & Quantity Controls Container -->
      <div class="filter-group slider-group price-quantity-container">
        <!-- Left Side: Price Range Filter with Customized Slider -->
        <div class="price-range-section">
          <!-- Price Header: Left and Right Sections -->
          <div class="price-header">
            <!-- Left: Price Label and Values -->
            <div class="price-left">
              <label>Price Range (‚Çπ)</label>
              <div class="slider-values">
                <span>‚Çπ{{ minPrice.toLocaleString('en-IN') }} - ‚Çπ{{ maxPrice.toLocaleString('en-IN') }}</span>
              </div>
            </div>

            <!-- Right: Sort by Price -->
            <div class="sort-price-section">
              <label>Sort by Price</label>
              <select [(ngModel)]="sortByPrice" class="filter-input">
                <option value="">No Sort</option>
                <option value="asc">Low to High</option>
                <option value="desc">High to Low</option>
              </select>
            </div>
          </div>

          <!-- Price Slider: Full Width Below -->
          <ngx-slider
            [(value)]="minPrice"
            [(highValue)]="maxPrice"
            [options]="priceSliderOptions"
          ></ngx-slider>
        </div>

        <!-- Bottom: Quantity Range Filter (Admin Only) with Customized Slider -->
        <div class="quantity-range-section">
          <!-- Quantity Header: Left and Right Sections -->
          <div class="quantity-header">
            <!-- Left: Quantity Label and Values -->
            <div class="quantity-left">
              <label>Quantity Range</label>
              <div class="slider-values">
                <span>{{ minQuantity }} - {{ maxQuantity }} items</span>
              </div>
            </div>

            <!-- Right: Sort by Quantity -->
            <div class="sort-quantity-section">
              <label>Sort by Quantity</label>
              <select [(ngModel)]="sortByQuantity" class="filter-input">
                <option value="">No Sort</option>
                <option value="asc">Lowest Stock First</option>
                <option value="desc">Highest Stock First</option>
              </select>
            </div>
          </div>

          <ngx-slider
            [(value)]="minQuantity"
            [(highValue)]="maxQuantity"
            [options]="quantitySliderOptions"
          ></ngx-slider>
        </div>
      </div>

      <!-- Category Filter -->
      <div class="filter-group category-filter">
        <label>Category</label>
        <select [(ngModel)]="selectedCategoryId" class="filter-input">
          <option [value]="null">All Categories</option>
          <option *ngFor="let category of categories" [value]="category.id">
            {{ category.name }} 
          </option>
        </select>
      </div>

      <!-- Show Deleted Products (Admin Only) -->
      <div class="filter-group checkbox-group">
        <label>
          <input type="checkbox" [(ngModel)]="includeDeleted" />
          Show Deleted Products
        </label>
      </div>
    </div>

    <!-- Filter Buttons -->
    <div class="filter-buttons">
      <button (click)="applyFilters()" class="btn-apply-filters">Apply Filters</button>
      <button (click)="resetFilters()" class="btn-reset-filters">Reset All</button>
    </div>
  </div>

  <!-- Messages -->
  <div *ngIf="errorMessage" class="alert alert-error">
    {{ errorMessage }}
  </div>
  <div *ngIf="successMessage" class="alert alert-success">
    {{ successMessage }}
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading">
    <p>Loading products...</p>
  </div>

  <!-- Products Table -->
  <div *ngIf="!isLoading && products.length > 0" class="table-responsive">
    <table class="products-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Description</th>
          <th>Category</th>
          <th>Price</th>
          <th>Quantity</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let product of products" [ngClass]="{ 'low-stock': product.stock < 10, 'deleted-product': product.isDeleted }">
          <td>{{ product.id }}</td>
          <td class="name-cell">{{ product.name }}</td>
          <td class="description-cell">{{ product.description }}</td>
          <td>{{ product.categoryName || 'N/A' }}</td>
          <td class="price-cell">‚Çπ{{ product.price.toFixed(2) }}</td>
          <td [ngClass]="{ 'low-stock-text': product.stock < 10 }">
            {{ product.stock }}
          </td>
          <td>
            <span *ngIf="product.isDeleted" class="badge badge-deleted">Deleted</span>
            <span *ngIf="!product.isDeleted" class="badge badge-active">Active</span>
          </td>
          <td class="actions-cell">
            <button
              *ngIf="!product.isDeleted"
              (click)="openEditProductModal(product)"
              class="btn-edit"
              title="Edit"
            >
              Edit
            </button>
            <button
              *ngIf="!product.isDeleted"
              (click)="openRestockModal(product)"
              class="btn-restock"
              title="Restock"
            >
              Restock
            </button>
            <button
              *ngIf="!product.isDeleted"
              (click)="openDeleteConfirm(product.id)"
              class="btn-delete"
              title="Delete"
            >
              Delete
            </button>
            <button
              *ngIf="product.isDeleted"
              (click)="restoreProduct(product.id)"
              class="btn-restore"
              title="Restore"
            >
              Restore
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && products.length === 0" class="empty-state">
    <p>No products found. Try adjusting your search or add a new product.</p>
  </div>

  <!-- Pagination -->
  <div *ngIf="!isLoading && totalPages > 0" class="pagination">
    <button
      (click)="previousPage()"
      [disabled]="currentPage === 1"
      class="btn-pagination"
    >
      Previous
    </button>

    <div class="page-numbers">
      <button
        *ngFor="let page of getPageNumbers()"
        (click)="goToPage(page)"
        [ngClass]="{ active: page === currentPage }"
        class="page-number"
      >
        {{ page }}
      </button>
    </div>

    <button
      (click)="nextPage()"
      [disabled]="currentPage === totalPages"
      class="btn-pagination"
    >
      Next
    </button>

    <span class="page-info">
      Page {{ currentPage }} of {{ totalPages }} (Total: {{ totalCount }})
    </span>
  </div>
</div>

<!-- Add Product Modal -->
<div *ngIf="showAddProductModal" class="modal-overlay" (click)="closeAddProductModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Add New Product</h2>
      <button (click)="closeAddProductModal()" class="btn-close">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Product Name *</label>
        <input
          type="text"
          [(ngModel)]="newProduct.name"
          placeholder="Enter product name"
          class="form-input"
        />
      </div>
      <div class="form-group">
        <label>Description *</label>
        <textarea
          [(ngModel)]="newProduct.description"
          placeholder="Enter product description"
          class="form-input"
          rows="3"
        ></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Price *</label>
          <input
            type="number"
            [(ngModel)]="newProduct.price"
            placeholder="0.00"
            min="0"
            step="0.01"
            class="form-input"
          />
        </div>
        <div class="form-group">
          <label>Quantity *</label>
          <input
            type="number"
            [(ngModel)]="newProduct.stock"
            placeholder="0"
            min="0"
            class="form-input"
          />
        </div>
      </div>
      <div class="form-group">
        <label>Category *</label>
        <select [(ngModel)]="newProduct.categoryId" class="form-input">
          <option value="" disabled>Select a category</option>
          <option *ngFor="let category of categories" [value]="category.id">
            {{ category.name }}
          </option>
        </select>
      </div>
      <div class="form-group">
        <label>Product Image *</label>
        <div class="image-upload-section">
          <input
            type="file"
            #imageInput
            (change)="onImageSelected($event)"
            accept="image/*"
            class="file-input"
            id="imageInputAdd"
          />
          <label for="imageInputAdd" class="file-label">
            <span class="file-icon">üìÅ</span>
            <span class="file-text">{{ selectedImageFile ? selectedImageFile.name : 'Choose Image' }}</span>
          </label>
          
          <!-- Image Preview -->
          <div *ngIf="imagePreviewUrl" class="image-preview">
            <img [src]="imagePreviewUrl" alt="Preview" />
            <button type="button" (click)="clearImageSelection()" class="btn-clear-image">
              ‚úï
            </button>
          </div>

          <!-- Upload Button -->
          <div *ngIf="selectedImageFile && !uploadedImageUrl" class="upload-actions">
            <button
              type="button"
              (click)="uploadImageAndAddProduct()"
              [disabled]="isUploadingImage"
              class="btn-upload-image"
            >
              {{ isUploadingImage ? 'Uploading...' : '‚¨Ü Upload Image' }}
            </button>
          </div>

          <!-- Uploaded Status -->
          <div *ngIf="uploadedImageUrl" class="upload-success">
            <p>‚úì Image uploaded successfully</p>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button (click)="closeAddProductModal()" class="btn-cancel">
        Cancel
      </button>
      <button 
        (click)="addProduct()" 
        [disabled]="!uploadedImageUrl || isUploadingImage"
        class="btn-submit"
      >
        Add Product
      </button>
    </div>
  </div>
</div>

<!-- Edit Product Modal -->
<div *ngIf="showEditProductModal" class="modal-overlay" (click)="closeEditProductModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Edit Product</h2>
      <button (click)="closeEditProductModal()" class="btn-close">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Product Name *</label>
        <input
          type="text"
          [(ngModel)]="editProduct.name"
          placeholder="Enter product name"
          class="form-input"
        />
      </div>
      <div class="form-group">
        <label>Description *</label>
        <textarea
          [(ngModel)]="editProduct.description"
          placeholder="Enter product description"
          class="form-input"
          rows="3"
        ></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Price *</label>
          <input
            type="number"
            [(ngModel)]="editProduct.price"
            placeholder="0.00"
            min="0"
            step="0.01"
            class="form-input"
          />
        </div>
        <div class="form-group">
          <label>Category *</label>
          <select [(ngModel)]="editProduct.categoryId" class="form-input">
            <option value="" disabled>Select a category</option>
            <option *ngFor="let category of categories" [value]="category.id">
              {{ category.name }}
            </option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Product Image</label>
        <div class="image-upload-section">
          <input
            type="file"
            #imageInputEdit
            (change)="onImageSelectedEdit($event)"
            accept="image/*"
            class="file-input"
            id="imageInputEdit"
          />
          <label for="imageInputEdit" class="file-label">
            <span class="file-icon">üìÅ</span>
            <span class="file-text">{{ selectedImageForEdit ? selectedImageForEdit.name : 'Choose Image' }}</span>
          </label>
          
          <!-- Image Preview -->
          <div *ngIf="imagePreviewUrlEdit" class="image-preview">
            <img [src]="imagePreviewUrlEdit" alt="Preview" />
            <button type="button" (click)="clearImageSelectionEdit()" class="btn-clear-image">
              ‚úï Clear
            </button>
          </div>

          <!-- Upload Button -->
          <div *ngIf="selectedImageForEdit && !uploadedImageUrlEdit" class="upload-actions">
            <button
              type="button"
              (click)="uploadImageAndUpdateProduct()"
              [disabled]="isUploadingImage"
              class="btn-upload-image"
            >
              {{ isUploadingImage ? 'Uploading...' : '‚¨Ü Upload Image' }}
            </button>
          </div>

          <!-- Uploaded Status -->
          <div *ngIf="uploadedImageUrlEdit" class="upload-success">
            <p>‚úì Image uploaded successfully</p>
          </div>

          <!-- Current Image -->
          <div *ngIf="editProduct.imageUrl && !selectedImageForEdit" class="current-image">
            <p>Current Image:</p>
            <img [src]="editProduct.imageUrl" alt="Current product image" />
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button (click)="closeEditProductModal()" class="btn-cancel">
        Cancel
      </button>
      <button (click)="updateProduct()" class="btn-submit">Update Product</button>
    </div>
  </div>
</div>

<!-- Restock Modal -->
<div *ngIf="showRestockModal" class="modal-overlay" (click)="closeRestockModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Restock Product</h2>
      <button (click)="closeRestockModal()" class="btn-close">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Add Quantity *</label>
        <input
          type="number"
          [(ngModel)]="restockData.quantityToAdd"
          placeholder="0"
          min="1"
          class="form-input"
        />
      </div>
    </div>
    <div class="modal-footer">
      <button (click)="closeRestockModal()" class="btn-cancel">Cancel</button>
      <button (click)="restockProduct()" class="btn-submit">Restock</button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div *ngIf="showDeleteConfirm" class="modal-overlay" (click)="closeDeleteConfirm()">
  <div class="modal modal-small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirm Delete</h2>
      <button (click)="closeDeleteConfirm()" class="btn-close">&times;</button>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to delete this product? This action cannot be undone.</p>
    </div>
    <div class="modal-footer">
      <button (click)="closeDeleteConfirm()" class="btn-cancel">Cancel</button>
      <button (click)="confirmDelete()" class="btn-danger">Delete</button>
    </div>
  </div>
</div>
