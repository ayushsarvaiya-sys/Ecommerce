<div class="user-products-container">
  <div class="products-header">
    <h1>Products</h1>
  </div>

  <!-- Search Bar -->
  <div class="search-bar">
    <input
      type="text"
      placeholder="Search by product name or ID..."
      [(ngModel)]="searchTerm"
      (keyup.enter)="onSearch()"
      class="search-input"
    />
    <button (click)="onSearch()" class="btn-search">Search</button>
    <button (click)="clearSearch()" class="btn-clear">Clear</button>
  </div>

  <!-- Filters Section -->
  <div class="filters-section">
    <h3>Filters</h3>
    <div class="filters-grid">
      <!-- Category Filter -->
      <!-- <div class="filter-group">
        <label>Category</label>
        <select [(ngModel)]="selectedCategoryId" class="filter-input">
          <option [value]="null">All Categories</option>
          <option *ngFor="let category of categories" [value]="category.id">
            {{ category.name }}
          </option>
        </select>
      </div> -->

      <!-- Price Range Filter with Customized Slider -->
      <!-- Price Range Filter with Customized Slider -->
      <div class="filter-group slider-group">
        <div class="price-range-section">
          <!-- Price Header: Left and Right Sections -->
          <div class="price-header">
            <!-- Left: Price Label and Values -->
            <div class="price-left">
              <label>Price Range (₹)</label>
              <div class="slider-values">
                <span>₹{{ minPrice.toLocaleString('en-IN') }} - ₹{{ maxPrice.toLocaleString('en-IN') }}</span>
              </div>
            </div>

            <!-- Right: Sort by Price (Admin Only) -->
            <div class="sort-price-section" *ngIf="userRole === 'Admin'">
              <label>Sort by Price</label>
              <select [(ngModel)]="sortByPrice" class="filter-input">
                <option value="">No Sort</option>
                <option value="asc">Low to High</option>
                <option value="desc">High to Low</option>
              </select>
            </div>
          </div>

          <!-- Price Slider: Full Width Below -->
          <ngx-slider
            [(value)]="minPrice"
            [(highValue)]="maxPrice"
            [options]="priceSliderOptions"
          ></ngx-slider>
        </div>
      </div>

      <!-- Admin-Only Filters -->
      <ng-container *ngIf="userRole === 'Admin'">
        <!-- Bottom: Quantity Range Filter (Admin Only) with Customized Slider -->
        <div class="filter-group slider-group">
          <div class="quantity-range-section">
            <!-- Quantity Header: Left and Right Sections -->
            <div class="quantity-header">
              <!-- Left: Quantity Label and Values -->
              <div class="quantity-left">
                <label>Quantity Range</label>
                <div class="slider-values">
                  <span>{{ minQuantity }} - {{ maxQuantity }} items</span>
                </div>
              </div>

              <!-- Right: Sort by Quantity -->
              <div class="sort-quantity-section">
                <label>Sort by Quantity</label>
                <select [(ngModel)]="sortByQuantity" class="filter-input">
                  <option value="">No Sort</option>
                  <option value="asc">Lowest Stock First</option>
                  <option value="desc">Highest Stock First</option>
                </select>
              </div>
            </div>

            <ngx-slider
              [(value)]="minQuantity"
              [(highValue)]="maxQuantity"
              [options]="quantitySliderOptions"
            ></ngx-slider>
          </div>
        </div>
        
        <div class="filter-group">
        <label>Category</label>
        <select [(ngModel)]="selectedCategoryId" class="filter-input">
          <option [value]="null">All Categories</option>
          <option *ngFor="let category of categories" [value]="category.id">
            {{ category.name }}
          </option>
        </select>
      </div>

        <!-- Show Deleted Products (Admin Only) -->
        <div class="filter-group checkbox-group">
          <label>
            <input type="checkbox" [(ngModel)]="includeDeleted" />
            Show Deleted Products
          </label>
        </div>
      </ng-container>
    </div>

    <!-- Filter Buttons -->
    <div class="filter-buttons">
      <button (click)="applyFilters()" class="btn-apply-filters">Apply Filters</button>
      <button (click)="resetFilters()" class="btn-reset-filters">Reset All</button>
    </div>
  </div>

  <!-- Messages -->
  <div *ngIf="errorMessage" class="alert alert-error">
    {{ errorMessage }}
  </div>

  <div *ngIf="successMessage" class="alert alert-success">
    {{ successMessage }}
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading">
    <p>Loading products...</p>
  </div>

  <!-- Products Grid -->
  <div *ngIf="!isLoading && products.length > 0" class="products-grid">
    <div *ngFor="let product of products" class="product-card">
      <div class="product-image">
        <img
          src="{{ product.imageUrl }}"
          alt="{{ product.name }}"
        />
      </div>
      <div class="product-info">
        <h3>{{ product.name }}</h3>
        <p class="category" *ngIf="product.categoryName">
          {{ product.categoryName }}
        </p>
        <p class="description">{{ product.description }}</p>
        <div class="product-footer">
          <div class="price-stock">
            <span class="price">₹{{ product.price.toFixed(2) }}</span>
            <span
              class="stock"
              [ngClass]="{ 'low-stock': getAvailableStock(product) > 0 && getAvailableStock(product) < 10 }"
            >
              {{ getStockStatusText(product) }}
            </span>
          </div>

          <!-- Add to Cart Section (for non-admin users with stock) -->
          <div *ngIf="userRole !== 'Admin' && isProductAvailable(product)" class="add-to-cart-section">
            <div class="quantity-control">
              <button
                (click)="decrementQuantity(product.id)"
                [disabled]="cartQuantities[product.id] <= 1 || addingToCart[product.id]"
                class="qty-btn"
              >
                -
              </button>
              <input
                type="number"
                [(ngModel)]="cartQuantities[product.id]"
                (change)="initializeCartQuantity(product.id)"
                [disabled]="addingToCart[product.id]"
                class="qty-input"
                min="1"
                [attr.max]="getAvailableStock(product) < 999999 ? getAvailableStock(product) : 999"
              />
              <button
                (click)="incrementQuantity(product.id)"
                [disabled]="getAvailableStock(product) < 999999 && cartQuantities[product.id] >= getAvailableStock(product) || addingToCart[product.id]"
                class="qty-btn"
              >
                +
              </button>
            </div>
            <button
              (click)="addToCart(product)"
              [disabled]="addingToCart[product.id]"
              class="btn-add-to-cart"
            >
              {{ addingToCart[product.id] ? 'Adding...' : 'Add to Cart' }}
            </button>
            <div *ngIf="cartAddedSuccess[product.id]" class="added-success">
              ✓ Added to cart
            </div>
          </div>

          <!-- Out of Stock Button (for users) -->
          <button
            *ngIf="userRole !== 'Admin' && !isProductAvailable(product)"
            disabled
            class="btn-out-of-stock"
          >
            Out of Stock
          </button>

          <!-- Add to Cart Button Disabled (for admins) -->
          <button
            *ngIf="userRole === 'Admin'"
            disabled
            class="btn-out-of-stock"
          >
            Add to Cart
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && products.length === 0" class="empty-state">
    <p>No products found. Try adjusting your search.</p>
  </div>

  <!-- Pagination -->
  <div *ngIf="!isLoading && totalPages > 0" class="pagination">
    <button
      (click)="previousPage()"
      [disabled]="currentPage === 1"
      class="btn-pagination"
    >
      Previous
    </button>

    <div class="page-numbers">
      <button
        *ngFor="let page of getPageNumbers()"
        (click)="goToPage(page)"
        [ngClass]="{ active: page === currentPage }"
        class="page-number"
      >
        {{ page }}
      </button>
    </div>

    <button
      (click)="nextPage()"
      [disabled]="currentPage === totalPages"
      class="btn-pagination"
    >
      Next
    </button>

    <span class="page-info">
      Page {{ currentPage }} of {{ totalPages }} (Total: {{ totalCount }})
    </span>
  </div>
</div>
